# 概要设计说明书

## 1. 设计目标与范围

**目标**：

构建一个完整可运行的旅行规划助手，实现从语音/文字输入 → AI行程生成 → 预算估算 → 费用记录 → 地图展示 → 云端同步的完整闭环。

**范围**：

- 支持语音或文字输入自动生成个性化的行程规划与预算分析。
- 用户可确认行程，确认后存入云端。
- 支持预算估算与实时记账功能。
- 支持云端同步与跨设备访问。

---

## 2. 总体架构

### 2.1 架构风格

- 前后端分离：React 前端负责 UI 与交互；Spring Boot 后端负责业务逻辑。
- 云端数据存储与认证：Firebase Authentication + Firestore。
- 后端缓存：Redis 用于行程预览与数据加速。
- 外部API统一由后端代理：科大讯飞STT、高德地图API、阿里云百炼LLM。

### 2.2 架构组件

- **web-app（React + Vite）**：
  - 用户认证（Firebase Auth SDK）。
  - 行程规划展示、预算分析页面、开销记录与查看。
  - 地图点位与路线绘制（高德地图Web）。

- **api-server（Spring Boot）**：
  - 封装RESTful API（认证、行程管理、预算与记账）。
  - Firebase Admin SDK 集成认证与Firestore数据存储。
  -   Redis缓存用于加速行程预览与已确认行程访问。
  - 封装第三方接口调用（科大讯飞、阿里云百炼、高德地图）。

- **database（Firestore）**：
  - 存储所有业务数据：用户、行程、活动、预算、开销。
  - 数据以文档形式存储，无需额外表关联。

- **cache（Redis）**：
  - 存放临时未确认行程预览（TTL约30分钟）。
  - 缓存最近访问的行程数据（TTL约6小时），减少Firestore读取频率。

### 2.3 技术选型

| 分类     | 技术选型                         |
| -------- | -------------------------------- |
| 编程语言 | Java（后端）、TypeScript（前端） |
| 后端框架 | Spring Boot                      |
| 前端框架 | React + Vite                     |
| 数据库   | Firestore                        |
| 用户认证 | Firebase Authentication          |
| 缓存系统 | Redis                            |
| 行程规划 | 阿里云百炼 LLM                   |
| 语音识别 | 科大讯飞                         |
| 地图导航 | 高德地图 API                     |
| 部署方式 | Docker Compose                   |

---

## 3. 模块划分与职责（后端模块）

```
server/
├─ controller/       # 接口层，HTTP请求响应
├─ service/          # 业务逻辑层（行程规划、预算计算、开销记录）
├─ repository/       # Firestore存储交互（Firestore SDK）
├─ thirdparty/       # 外部接口调用（讯飞STT、Qwen、Amap API）
├─ domain/           # 领域模型定义（Trip、Day、Activity、Expense）
├─ security/         # Firebase Auth JWT验证
└─ config/           # Spring配置（WebClient、CORS、Firebase、Redis）
```

## 4. 数据结构设计

### 4.1 Firestore 数据结构

Firestore 采用文档型结构，不使用多表关联。  

顶层集合为 `trips`，每个行程文档包含完整的聚合信息，子集合管理活动与开销。

#### 顶层结构：`/trips/{tripId}`

| 字段名                    | 类型                | 说明                           |
| ------------------------- | ------------------- | ------------------------------ |
| `id`                      | string              | 行程唯一标识（UUID）           |
| `userId`                  | string              | 行程所属用户ID（Firebase UID） |
| `title`                   | string              | 行程标题                       |
| `destination`             | string              | 目的地                         |
| `startDate` / `endDate`   | string (YYYY-MM-DD) | 行程起止日期                   |
| `currency`                | string              | 货币类型                       |
| `totalBudget`             | number              | 总预算（分）                   |
| `headcount`               | object              | `{ adults, children }`         |
| `preferences`             | array               | 用户偏好（如“美食”“亲子”）     |
| `createdAt` / `updatedAt` | timestamp           | 创建与更新时间                 |
| `days`                    | array               | 行程天数组，每天包含活动信息   |

#### 子集合：`/trips/{tripId}/expenses`

| 字段名        | 类型      | 说明                                |
| ------------- | --------- | ----------------------------------- |
| `id`          | string    | 支出ID                              |
| `category`    | string    | 支出类别（food/ticket/hotel/other） |
| `amountCents` | number    | 金额（分）                          |
| `note`        | string    | 备注                                |
| `happenedAt`  | timestamp | 发生时间                            |

---

### 4.2 Redis 缓存结构

Redis 仅用于短期缓存行程与加速访问，缓存键规则：

| 缓存键                 | 说明                   | 内容                             |
| ---------------------- | ---------------------- | -------------------------------- |
| `trip:{tripId}`        | 未确认或最近访问的行程 | JSON字符串，完整Trip聚合对象     |
| `trip:{tripId}:budget` | 单个行程的预算汇总     | JSON字符串，缓存计算后的预算汇总 |

#### 缓存数据示例

**缓存键**：`trip:{tripId}`

```json
{
  "id": "trip-uuid",
  "userId": "user-uuid",
  "title": "日本亲子游",
  "destination": "日本 京都/奈良",
  "startDate": "2025-11-02",
  "endDate": "2025-11-06",
  "currency": "CNY",
  "totalBudget": 1000000,
  "headcount": { "adults": 2, "children": 1 },
  "preferences": ["美食", "动漫", "亲子"],
  "days": [
    {
      "dayIndex": 1,
      "activities": [
        {
          "id": "activity-uuid-1",
          "type": "sight",
          "title": "伏见稻荷大社",
          "lat": 34.9671,
          "lng": 135.7727,
          "estimatedCost": 0
        },
        {
          "id": "activity-uuid-2",
          "type": "food",
          "title": "一兰拉面",
          "lat": 34.9856,
          "lng": 135.7580,
          "estimatedCost": 8000
        }
      ]
    },
    {
      "dayIndex": 2,
      "activities": [ /* ...其他活动... */ ]
    }
  ],
  "createdAt": "2025-11-01T12:00:00Z",
  "updatedAt": "2025-11-01T12:00:00Z"
}

```

**缓存键**：``trip:{tripId}:budget`

```json
{
  "tripId": "trip-uuid",
  "budget": {
    "byCategory": [
      { "category": "hotel", "plannedCents": 350000 },
      { "category": "food", "plannedCents": 250000 },
      { "category": "transport", "plannedCents": 150000 },
      { "category": "ticket", "plannedCents": 100000 },
      { "category": "other", "plannedCents": 150000 }
    ],
    "totals": { "plannedCents": 1000000 }
  },
  "calculatedAt": "2025-11-01T12:05:00Z"
}

```

---

## 5. 关键接口模块设计

### 1. 身份认证与会话

| 方法 | 路径                 | 鉴权 | 用途     | 说明                                                         |
| ---- | -------------------- | ---- | -------- | ------------------------------------------------------------ |
| POST | /auth/signup         | 否   | 注册     | 后端对接 Supabase Auth；成功直接返回令牌对                   |
| POST | /auth/login          | 否   | 登录     | 登录后前端保存 `accessToken/refreshToken`，后续带 Bearer 调用 |
| POST | /auth/refresh        | 否   | 刷新令牌 | 旋转 refreshToken，旧 refreshToken 失效                      |
| POST | /auth/logout         | 是   | 退出     | 服务端失效该 refreshToken（黑名单/撤销）                     |
| GET  | /auth/me             | 是   | 当前用户 | 读取 profiles / auth.users 聚合信息                          |
| POST | /auth/delete-account | 是   | 注销账户 | 可选择性清理名下业务数据                                     |

### 2. 行程与预算

#### 接口设计说明：

- 创建行程后，行程对象首先存入 Redis 缓存，设定适当的TTL（例如30分钟）。
- 前端无需区分数据来源，后端自动处理 Redis 缓存与 Supabase 数据库的数据同步。
- 若行程未确认（仅存在Redis缓存），过期自动删除。
- 确认行程后，数据从 Redis 写入 Supabase 云端存储。

#### 2.1 创建行程预览（缓存阶段）

| 方法 | 路径         | 鉴权 | 用途             | 说明                                                         |
| ---- | ------------ | ---- | ---------------- | ------------------------------------------------------------ |
| POST | /trips       | 是   | 文字创建行程预览 | 创建 `Trip` 对象，存入 Redis 缓存（TTL=30min）；返回生成的 `tripId` |
| POST | /trips/voice | 是   | 语音创建行程预览 | 后端STT识别语音后，调用与文字相同流程；存入 Redis 并返回生成的 `tripId` |

#### 2.2 获取行程与预算信息

> 说明：前端调用以下接口时，后端逻辑如下：
>
> 1. 优先从 Redis 获取数据；
> 2. Redis 未命中，再从数据库查询；
> 3. 数据库查询到结果后，回写到 Redis 缓存；

| 方法 | 路径                        | 鉴权 | 用途                 | 说明                                              |
| ---- | --------------------------- | ---- | -------------------- | ------------------------------------------------- |
| GET  | `/trips/{tripId}/itinerary` | 是   | 获取行程地图预览信息 | 活动的 `id` 未确认行程可为null                    |
| GET  | `/trips/{tripId}/budget`    | 是   | 获取预算分析信息     | 未确认状态 `actualCents` 为 0，确认后从数据库更新 |

#### 2.3 确认并入库（将缓存行程存入数据库）

| 方法 | 路径                    | 鉴权 | 用途                     | 说明                                               |
| ---- | ----------------------- | ---- | ------------------------ | -------------------------------------------------- |
| POST | /trips/{tripId}/confirm | 是   | 确认行程，正式保存至云端 | 确认成功后：Redis数据写入Supabase，并更新Redis缓存 |

#### 2.4 已确认行程列表查看

| 方法 | 路径     | 鉴权 | 用途               | 查询参数 (`Query`)          | 说明                                   |
| ---- | -------- | ---- | ------------------ | --------------------------- | -------------------------------------- |
| GET  | `/trips` | 是   | 获取已确认行程列表 | `page?`, `pageSize?` (分页) | 只返回已确认的行程摘要（来自Supabase） |

### 3. 开销（仅记录/查看）

| 方法 | 路径                           | 鉴权 | 用途     | 说明                                                         |
| ---- | ------------------------------ | ---- | -------- | ------------------------------------------------------------ |
| POST | /trips/{tripId}/expenses       | 是   | 文字记账 | `category` 取：`food/ticket/transport/hotel/other`；不与活动关联 |
| POST | /trips/{tripId}/expenses/voice | 是   | 语音记账 | 后端：STT → 金额/类别解析 → 入库                             |
| GET  | /trips/{tripId}/expenses       | 是   | 开销列表 | 同时返回分类与总计，便于“预算差异”呈现                       |

## 6. 核心业务流程

### 6.1 创建行程

1. 用户提交文字或语音输入；
2. 后端调用LLM生成行程对象；
3. 系统创建UUID并将完整行程对象存入Redis；
4. 返回`tripId`给前端；
5. Redis缓存该行程的信息，过期自动删除。

### 6.2 查看行程/预算

1. 用户请求`/trips/{tripId}/itinerary`或`/trips/{tripId}/budget`；
2. 系统先查Redis，如存在直接返回；
3. Redis未命中，则从Firestore读取、重建聚合对象后缓存。

### 6.3 确认行程

1. 用户确认行程；
2. 后端从Redis读取行程对象；
3. 校验数据完整性后写入Firestore；
4. 更新Redis缓存；
5. 返回完整行程详情。

### 6.4 记录与查看开销

1. 用户在行程详情页语音或文字输入支出；
2. 后端解析金额和类别后写入Firestore子集合；
4. 用户可通过预算接口实时查看支出差异。

---

## 7. 部署与安全设计

### 7.1 部署流程

- 整个项目使用Docker容器化
- 镜像托管在阿里云ACR；
- Firebase配置与Redis连接参数通过环境变量注入

### 7.2 安全策略

- **认证**：Firebase Access Token验证；
- **授权**：后端校验当前用户与`trip.userId`一致；
- **密钥管理**：所有API Key通过环境变量配置；
